<!-- app/templates/epics.html -->

{% extends "base.html" %}

{% block title %}√âpicos - AI Product Owner{% endblock %}

{% block head %}
<style>
    /* Estilos espec√≠ficos para a p√°gina de √©picos */
    .epic-item {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .epic-item:hover {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .epic-item.filtered-out {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Anima√ß√£o para os √≠cones */
    .btn-icon {
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
    }

    .btn-icon:hover {
        transform: scale(1.1);
    }

    /* Loading state para busca */
    .search-loading {
        position: relative;
    }

    .search-loading::after {
        content: '';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    /* Anima√ß√£o suave para grid */
    #epics-list {
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilos espec√≠ficos para badges de status */
    .badge-draft {
        background-color: #fef3c7;
        color: #92400e;
    }

    .badge-active {
        background-color: #dcfce7;
        color: #166534;
    }

    .badge-in_review {
        background-color: #dbeafe;
        color: #1d4ed8;
    }

    .badge-approved {
        background-color: #d1fae5;
        color: #065f46;
    }

    .badge-done {
        background-color: #e0e7ff;
        color: #3730a3;
    }

    /* Progress bar customizada */
    .progress-gradient {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        transition: width 0.3s ease;
    }

    /* Anima√ß√£o de hover nos stats cards */
    .stat-card-hover {
        transition: all 0.2s ease;
    }

    .stat-card-hover:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Anima√ß√µes para contadores dos cards */
    .stat-card-stories .text-sm.font-semibold {
        transition: all 0.3s ease;
    }

    .stat-card-stories.highlight .text-sm.font-semibold {
        color: #16a34a;
    }

    /* Anima√ß√£o para barra de progresso */
    .progress-bar-animated {
        transition: width 0.5s ease-in-out;
    }

    /* Pulse animation para estat√≠sticas atualizadas - REMOVIDO */
    .stats-updated {
        border-color: #22c55e !important;
    }

    /* Toast Notifications */
    .toast-notification {
        backdrop-filter: blur(8px);
        border-left: 4px solid rgba(255, 255, 255, 0.5);
    }

    .toast-notification.bg-green-500 {
        background: linear-gradient(135deg, #10b981, #059669);
        border-left-color: #d1fae5;
    }

    .toast-notification.bg-red-500 {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-left-color: #fecaca;
    }

    .toast-notification.bg-blue-500 {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border-left-color: #dbeafe;
    }

    /* Efeito hover melhorado para bot√£o de gerar hist√≥rias */
    .btn-icon[title="Gerar Hist√≥rias"]:hover {
        background: linear-gradient(135deg, #10b981, #059669) !important;
        color: white !important;
        transform: scale(1.15);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    /* Feedback visual para a√ß√µes em andamento */
    .generating-stories {
        position: relative;
        overflow: hidden;
    }

    .generating-stories::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.2), transparent);
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* Loading state para contadores */
    .stat-loading {
        opacity: 0.6;
        position: relative;
    }

    .stat-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 12px;
        height: 12px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #22c55e;
        border-radius: 50%;
        animation: spin-center 1s linear infinite;
    }

    @keyframes spin-center {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Gerenciamento de √âpicos</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Gere, revise e organize os √©picos dos seus produtos.</p>
        </div>
        <div class="flex gap-3">
            <button onclick="openGenerateEpicsModal()" class="btn-primary"> {# Chamada para o modal de gera√ß√£o IA #}
                <i class="fas fa-magic mr-2"></i>
                Gerar com IA
            </button>
            <button onclick="openCreateEpicModal()" class="btn-primary"> {# Novo bot√£o para criar √©pico manualmente #}
                <i class="fas fa-plus mr-2"></i>
                Novo √âpico
            </button>
        </div>
    </div>

    <!-- Barra de Pesquisa e Filtros -->
    <div class="stat-card mb-8">
        <!-- Header da Se√ß√£o de Filtros -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-2">
                <i class="fas fa-filter text-blue-600 dark:text-blue-400"></i>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Filtros e Pesquisa</h2>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                <span id="resultsCount">{{ epics_data|length if epics_data else 0 }}</span> √©pico(s) encontrado(s)
            </div>
        </div>

        <!-- Controles de Filtro -->
        <div class="space-y-4">
            <!-- Campo de Pesquisa -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-search mr-1"></i>
                    Buscar √âpicos
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Pesquisar por t√≠tulo, descri√ß√£o ou produto..." 
                           class="block w-full pl-10 pr-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                           autocomplete="off">
                </div>
            </div>
            
            <!-- Filtros e A√ß√µes -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <!-- Filtro por Produto -->
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-box mr-1"></i>
                        Filtrar por Produto:
                    </label>
                    <select id="productFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <option value="">üì¶ Todos os Produtos</option>
                        <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
                    </select>
                </div>
                
                <!-- Filtro por Status -->
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-flag mr-1"></i>
                        Status:
                    </label>
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <option value="">üè∑Ô∏è Todos os Status</option>
                        <option value="draft">üìù Rascunho</option>
                        <option value="active">‚úÖ Ativo</option>
                        <option value="in_review">üëÄ Em Revis√£o</option>
                        <option value="approved">‚úÖ Aprovado</option>
                        <option value="done">üéØ Conclu√≠do</option>
                    </select>
                </div>
                
                <!-- Ordena√ß√£o -->
                <div class="flex flex-col">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-sort mr-1"></i>
                        Ordenar por:
                    </label>
                    <select id="sortOrder" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <option value="newest">üìÖ Mais Recentes</option>
                        <option value="oldest">üìÖ Mais Antigos</option>
                        <option value="title-asc">üî§ T√≠tulo (A-Z)</option>
                        <option value="title-desc">üî§ T√≠tulo (Z-A)</option>
                        <option value="product">üì¶ Por Produto</option>
                    </select>
                </div>
            </div>
            
            <!-- Bot√£o Limpar Filtros -->
            <div class="flex justify-end">
                <button onclick="clearFilters()" class="flex items-center gap-2 px-4 py-2 text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 hover:border-gray-300 dark:hover:border-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    <i class="fas fa-eraser"></i>
                    <span>Limpar Filtros</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de √âpicos -->
    <div id="epics-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% if epics_data %}
            {% for epic in epics_data %}
            <div class="epic-item project-card group hover:shadow-md transition-all duration-200 cursor-pointer" 
                 data-title="{{ epic.title|lower }}"
                 data-description="{{ epic.description|lower }}"
                 data-product-name="{{ epic.product_name|lower }}"
                 data-product-id="{{ epic.product_id }}"
                 data-status="{{ epic.status }}"
                 data-created="{{ epic.created_at_raw }}"
                 data-id="{{ epic.id }}"
                 onclick="navigateToStoriesWithEpic({{ epic.id }}, '{{ epic.title|replace("'", "\\'") }}')">>
                
                <!-- Header do Card -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200 line-clamp-2 mb-2">
                            {{ epic.title }}
                        </h3>
                        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                            <i class="fas fa-box"></i>
                            <span>{{ epic.product_name }}</span>
                            <span>‚Ä¢</span>
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{ epic.created_at }}</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 items-end">
                        <span class="badge badge-{{ epic.status }} flex-shrink-0">
                            {% if epic.status == 'active' %}
                                <i class="fas fa-play mr-1"></i>Ativo
                            {% elif epic.status == 'draft' %}
                                <i class="fas fa-edit mr-1"></i>Rascunho
                            {% elif epic.status == 'in_review' %}
                                <i class="fas fa-eye mr-1"></i>Em Revis√£o
                            {% elif epic.status == 'approved' %}
                                <i class="fas fa-check mr-1"></i>Aprovado
                            {% elif epic.status == 'done' %}
                                <i class="fas fa-check-circle mr-1"></i>Conclu√≠do
                            {% else %}
                                {{ epic.status | capitalize }}
                            {% endif %}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">#{{ epic.id }}</span>
                    </div>
                </div>
                
                <!-- Descri√ß√£o -->
                <div class="mb-4">
                    <p class="text-gray-600 dark:text-gray-400 text-sm line-clamp-3 leading-relaxed">
                        {{ epic.description }}
                    </p>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400 mb-2">
                        <span class="flex items-center gap-1">
                            <i class="fas fa-chart-line"></i>
                            Progresso
                        </span>
                        <span class="font-medium">{{ epic.progress | default(0) }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300" 
                             style="width: {{ epic.progress | default(0) }}%"></div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-3 gap-3 mb-4 px-6">
                    <!-- Hist√≥rias -->
                    <div class="stat-card-stories bg-blue-50 border border-blue-200 rounded-lg p-3 text-center hover:bg-blue-100 transition-colors stat-card-hover dark:bg-blue-900/20 dark:border-blue-700 dark:hover:bg-blue-900/30">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-file-text text-blue-600 mb-1 dark:text-blue-400"></i>
                            <span class="text-sm font-semibold text-blue-900 dark:text-blue-300">{{ epic.totalStories | default(0) }}</span>
                            <span class="text-xs text-blue-700 dark:text-blue-400">Hist√≥rias</span>
                        </div>
                    </div>
                    
                    <!-- Requisitos -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center hover:bg-green-100 transition-colors stat-card-hover dark:bg-green-900/20 dark:border-green-700 dark:hover:bg-green-900/30">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-list-ul text-green-600 mb-1 dark:text-green-400"></i>
                            <span class="text-sm font-semibold text-green-900 dark:text-green-300">{{ epic.totalRequirements | default(0) }}</span>
                            <span class="text-xs text-green-700 dark:text-green-400">Requisitos</span>
                        </div>
                    </div>
                    
                    <!-- Data de Cria√ß√£o -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center hover:bg-gray-100 transition-colors stat-card-hover dark:bg-gray-800 dark:border-gray-600 dark:hover:bg-gray-700">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-calendar text-gray-600 mb-1 dark:text-gray-400"></i>
                            <span class="text-xs font-semibold text-gray-900 dark:text-gray-300">{{ epic.created_at[:10] if epic.created_at else 'N/A' }}</span>
                            <span class="text-xs text-gray-700 dark:text-gray-400">Criado</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons Footer -->
                <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-600 px-6 pb-6">
                    <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-eye"></i>
                        <span>Clique para detalhes</span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="event.stopPropagation(); editEpic({{ epic.id }})" 
                                class="btn-icon text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20" 
                                title="Editar √âpico">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); generateStories({{ epic.id }})" 
                                class="btn-icon text-gray-400 dark:text-gray-500 hover:text-green-600 dark:hover:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20" 
                                title="Gerar Hist√≥rias">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteEpic({{ epic.id }})" 
                                class="btn-icon text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20" 
                                title="Excluir √âpico">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Estado Vazio - Nenhum √âpico -->
            <div id="noEpicsMessage" class="col-span-full">
                <div class="text-center py-12">
                    <div class="mx-auto w-24 h-24 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-bullseye text-gray-400 dark:text-gray-500 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Nenhum √©pico encontrado</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-sm mx-auto">
                        Voc√™ ainda n√£o criou nenhum √©pico. Comece gerando com IA ou criando um novo √©pico!
                    </p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="openGenerateEpicsModal()" class="btn-primary">
                            <i class="fas fa-magic mr-2"></i>
                            Gerar com IA
                        </button>
                        <button onclick="openCreateEpicModal()" class="btn-secondary">
                            <i class="fas fa-plus mr-2"></i>
                            Novo √âpico
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Estado Vazio - Nenhum Resultado de Busca -->
        <div id="noResultsMessage" class="col-span-full" style="display: none;">
            <div class="text-center py-12">
                <div class="mx-auto w-24 h-24 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-search text-blue-400 dark:text-blue-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Nenhum resultado encontrado</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-sm mx-auto">
                    N√£o encontramos √©picos que correspondam aos seus crit√©rios de busca. Tente termos diferentes.
                </p>
                <div class="flex gap-3 justify-center">
                    <button onclick="clearFilters()" class="btn-primary">
                        <i class="fas fa-eraser mr-2"></i>
                        Limpar Filtros
                    </button>
                    <button onclick="openCreateEpicModal()" class="btn-secondary">
                        <i class="fas fa-plus mr-2"></i>
                        Novo √âpico
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensagens de Feedback com Barra de Progresso -->
    <div id="feedback-message" class="mt-4 p-4 rounded-lg text-center font-medium" style="display: none;">
        <div id="feedback-content"></div>
        <div id="progress-container" class="mt-3" style="display: none;">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-xs text-gray-600 mt-1"></div>
        </div>
    </div>
</div>

<!-- Modal para Gerar √âpicos com IA -->
<div id="generateEpicsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-xl font-semibold dark:text-white">Gerar √âpicos com IA</h2>
            <button onclick="closeModal('generateEpicsModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="generateEpicsForm" onsubmit="generateEpics(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="productSelect" class="dark:text-gray-300">Selecione um Produto *</label>
                    <select id="productSelect" name="product_id" required 
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Carregando produtos...</option>
                        {# Op√ß√µes ser√£o carregadas via JavaScript #}
                    </select>
                </div>
                <div class="form-group">
                    <label for="customPrompt" class="dark:text-gray-300">Ajustar Prompt (Opcional)</label>
                    <textarea id="customPrompt" name="custom_prompt" rows="4"
                              placeholder="Ex: 'Foque em funcionalidades de seguran√ßa e privacidade.'"
                              class="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Isso adicionar√° instru√ß√µes extras ao prompt padr√£o da IA.</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeModal('generateEpicsModal')" class="btn-secondary">
                    Cancelar
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-magic mr-2"></i> Gerar √âpicos
                </button>
            </div>
        </form>
        <div id="modal-message" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>
    </div>
</div>

<!-- Modal para Criar Novo √âpico (Manualmente) -->
<div id="createEpicModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-xl font-semibold dark:text-white">Criar Novo √âpico</h2>
            <button onclick="closeModal('createEpicModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createEpicForm" onsubmit="createEpic(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="newEpicProductSelect" class="dark:text-gray-300">Produto *</label>
                    <select id="newEpicProductSelect" name="product_id" required 
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Carregando produtos...</option>
                        {# Op√ß√µes ser√£o carregadas via JavaScript #}
                    </select>
                </div>
                <div class="form-group">
                    <label for="epicTitle" class="dark:text-gray-300">T√≠tulo do √âpico *</label>
                    <input type="text" id="epicTitle" name="title" required 
                           placeholder="Ex: Gest√£o de Usu√°rios, M√≥dulo de Pagamento..."
                           class="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                </div>
                <div class="form-group">
                    <label for="epicDescription" class="dark:text-gray-300">Descri√ß√£o *</label>
                    <textarea id="epicDescription" name="description" required rows="3"
                              placeholder="Descreva o objetivo e escopo do √©pico..."
                              class="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('createEpicModal')" class="btn-secondary">
                    Cancelar
                </button>
                <button type="submit" class="btn-primary">
                    Criar √âpico
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Editar √âpico -->
<div id="editEpicModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-xl font-semibold dark:text-white">Editar √âpico</h2>
            <button onclick="closeModal('editEpicModal')" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editEpicForm" onsubmit="updateEpic(event)">
            <div class="modal-body">
                <input type="hidden" id="editEpicId" name="epic_id">
                
                <!-- Aviso sobre hist√≥rias associadas -->
                <div id="editWarningMessage" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg" style="display: none;">
                    <div class="flex items-center gap-2 text-yellow-800 dark:text-yellow-200">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="font-medium">Aten√ß√£o:</span>
                    </div>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                        Este √©pico possui hist√≥rias associadas. O t√≠tulo e descri√ß√£o n√£o podem ser alterados.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="editEpicTitle" class="dark:text-gray-300">T√≠tulo do √âpico *</label>
                    <input type="text" id="editEpicTitle" name="title" required 
                           placeholder="Ex: Gest√£o de Usu√°rios, M√≥dulo de Pagamento..."
                           class="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                </div>
                
                <div class="form-group">
                    <label for="editEpicDescription" class="dark:text-gray-300">Descri√ß√£o *</label>
                    <textarea id="editEpicDescription" name="description" required rows="3"
                              placeholder="Descreva o objetivo e escopo do √©pico..."
                              class="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editEpicStatus" class="dark:text-gray-300">Status *</label>
                    <select id="editEpicStatus" name="status" required 
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="active">‚úÖ Ativo</option>
                        <option value="in_review">üëÄ Em Revis√£o</option>
                        <option value="approved">‚úÖ Aprovado</option>
                        <option value="done">üéØ Conclu√≠do</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeModal('editEpicModal')" class="btn-secondary">
                    Cancelar
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Salvar Altera√ß√µes
                </button>
            </div>
        </form>
        <div id="modal-message-edit" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Arrays para armazenar dados originais para filtragem
    let allEpics = [];
    let allProducts = [];
    let searchTimeout;

    // Inicializar √©picos e carregar produtos ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        allEpics = Array.from(document.querySelectorAll('.epic-item'));
        updateResultsCount();
        loadProductsForFilter();
        
        // Listener para atualiza√ß√µes de requisitos de outras p√°ginas
        window.addEventListener('requirementStatusChanged', function(event) {
            console.log('Evento recebido: requisito atualizado, recarregando estat√≠sticas dos √©picos');
            loadEpicStatistics();
        });
        
        // Verificar se h√° flag de atualiza√ß√£o pendente no localStorage
        const updateFlag = localStorage.getItem('epicProgressUpdateNeeded');
        if (updateFlag) {
            try {
                const flagData = JSON.parse(updateFlag);
                // Se o flag foi criado nos √∫ltimos 30 segundos, atualizar
                const flagTime = new Date(flagData.timestamp);
                const now = new Date();
                if ((now - flagTime) < 30000) { // 30 segundos
                    console.log('Flag de atualiza√ß√£o detectado, recarregando estat√≠sticas dos √©picos');
                    loadEpicStatistics();
                }
                localStorage.removeItem('epicProgressUpdateNeeded'); // Limpar flag
            } catch (e) {
                localStorage.removeItem('epicProgressUpdateNeeded'); // Limpar flag inv√°lido
            }
        }
        
        // Carregar estat√≠sticas dos √©picos
        loadEpicStatistics();
        
        // Adicionar eventos de busca e filtro
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterEpics, 300);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchTimeout);
                filterEpics();
            }
        });

        // Eventos para filtros
        document.getElementById('productFilter').addEventListener('change', filterEpics);
        document.getElementById('statusFilter').addEventListener('change', filterEpics);
        document.getElementById('sortOrder').addEventListener('change', sortEpics);
    });

    // Fun√ß√£o para carregar estat√≠sticas de todos os √©picos
    async function loadEpicStatistics() {
        const epicCards = document.querySelectorAll('.epic-item[data-id]');
        
        for (const epicCard of epicCards) {
            const epicId = epicCard.getAttribute('data-id');
            if (epicId) {
                try {
                    await refreshEpicStats(epicId);
                } catch (error) {
                    console.error(`Erro ao carregar estat√≠sticas do √©pico ${epicId}:`, error);
                }
            }
        }
    }

    // Carregar produtos para o filtro
    async function loadProductsForFilter() {
        try {
            const response = await authenticatedFetch('/products', { method: 'GET' });
            if (response.ok) {
                allProducts = await response.json();
                const productFilter = document.getElementById('productFilter');
                
                allProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar produtos para filtro:', error);
        }
    }

    // Fun√ß√£o de filtragem de √©picos
    function filterEpics() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const productFilter = document.getElementById('productFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noEpicsMessage = document.getElementById('noEpicsMessage');
        let visibleCount = 0;

        // Adicionar classe de loading
        searchInput.classList.add('search-loading');

        setTimeout(() => {
            allEpics.forEach(epic => {
                const title = epic.getAttribute('data-title') || '';
                const description = epic.getAttribute('data-description') || '';
                const productName = epic.getAttribute('data-product-name') || '';
                const productId = epic.getAttribute('data-product-id') || '';
                const status = epic.getAttribute('data-status') || '';

                // Crit√©rios de busca
                const searchableText = `${title} ${description} ${productName}`;
                let matchesSearch = searchTerm === '' || searchableText.includes(searchTerm);
                let matchesProduct = productFilter === '' || productId === productFilter;
                let matchesStatus = statusFilter === '' || status === statusFilter;

                if (matchesSearch && matchesProduct && matchesStatus) {
                    epic.style.display = 'block';
                    epic.classList.remove('filtered-out');
                    visibleCount++;
                } else {
                    epic.style.display = 'none';
                    epic.classList.add('filtered-out');
                }
            });

            // Mostrar/ocultar mensagens
            if (noEpicsMessage) noEpicsMessage.style.display = 'none';
            
            if (visibleCount === 0 && (searchTerm !== '' || productFilter !== '' || statusFilter !== '')) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }

            updateResultsCount();
            searchInput.classList.remove('search-loading');
        }, 150);
    }

    // Fun√ß√£o de ordena√ß√£o de √©picos
    function sortEpics() {
        const sortOrder = document.getElementById('sortOrder').value;
        const epicsList = document.getElementById('epics-list');
        
        const epicItems = Array.from(document.querySelectorAll('.epic-item'));
        
        epicItems.sort((a, b) => {
            switch (sortOrder) {
                case 'newest':
                    const dateA = new Date(a.getAttribute('data-created') || '1970-01-01');
                    const dateB = new Date(b.getAttribute('data-created') || '1970-01-01');
                    return dateB - dateA;
                case 'oldest':
                    const dateC = new Date(a.getAttribute('data-created') || '1970-01-01');
                    const dateD = new Date(b.getAttribute('data-created') || '1970-01-01');
                    return dateC - dateD;
                case 'title-asc':
                    const titleA = (a.getAttribute('data-title') || '').toLowerCase();
                    const titleB = (b.getAttribute('data-title') || '').toLowerCase();
                    return titleA.localeCompare(titleB);
                case 'title-desc':
                    const titleC = (a.getAttribute('data-title') || '').toLowerCase();
                    const titleD = (b.getAttribute('data-title') || '').toLowerCase();
                    return titleD.localeCompare(titleC);
                case 'product':
                    const productA = (a.getAttribute('data-product-name') || '').toLowerCase();
                    const productB = (b.getAttribute('data-product-name') || '').toLowerCase();
                    return productA.localeCompare(productB);
                default:
                    return 0;
            }
        });

        // Reordenar elementos no DOM
        epicsList.innerHTML = '';
        epicItems.forEach(item => {
            epicsList.appendChild(item);
        });

        updateResultsCount();
    }

    // Limpar filtros
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('productFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('sortOrder').value = 'newest';
        
        clearTimeout(searchTimeout);
        
        allEpics.forEach(epic => {
            epic.style.display = 'block';
            epic.classList.remove('filtered-out');
        });

        document.getElementById('noResultsMessage').style.display = 'none';
        
        sortEpics();
        updateResultsCount();
    }

    // Atualizar contador de resultados
    function updateResultsCount() {
        const visibleEpics = allEpics.filter(epic => 
            epic.style.display !== 'none'
        ).length;
        
        document.getElementById('resultsCount').textContent = visibleEpics;
    }

    // Fun√ß√µes de Modal (reutilizadas de main.js, mas aqui para garantir que existem)
    function openGenerateEpicsModal() {
        document.getElementById('generateEpicsModal').style.display = 'flex';
        // Chamada para carregar produtos no select do modal de gera√ß√£o
        loadProductsIntoSelect('productSelect'); 
    }

    function openCreateEpicModal() {
        document.getElementById('createEpicModal').style.display = 'flex';
        // Chamada para carregar produtos no select do modal de cria√ß√£o manual
        loadProductsIntoSelect('newEpicProductSelect'); 
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Fun√ß√£o para carregar produtos no select de modais
    async function loadProductsIntoSelect(selectId) {
        const productSelect = document.getElementById(selectId);
        productSelect.innerHTML = '<option value="">Carregando produtos...</option>'; // Limpa e mostra loading

        try {
            // authenticatedFetch est√° em main.js
            const response = await authenticatedFetch('/products', { method: 'GET' }); // <--- Busca PRODUTOS
            if (response.ok) {
                const products = await response.json();
                productSelect.innerHTML = '<option value="">Selecione um produto</option>'; // Reset ap√≥s carregar

                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
            } else {
                const errorData = await response.json();
                console.error('Erro ao carregar produtos para o select:', errorData);
                productSelect.innerHTML = '<option value="">Erro ao carregar produtos</option>';
            }
        } catch (error) {
            console.error('Erro de rede ao carregar produtos para o select:', error);
            productSelect.innerHTML = '<option value="">Erro de conex√£o</option>';
        }
    }

    // --- NOVA FUN√á√ÉO: loadEpicsIntoSelect (para carregar √©picos no select) ---
    async function loadEpicsIntoSelect(selectId) {
        const epicSelect = document.getElementById(selectId);
        epicSelect.innerHTML = '<option value="">Carregando √©picos...</option>'; // Limpa e mostra loading

        try {
            // Chamar a NOVA rota de API para listar √©picos do usu√°rio
            const response = await authenticatedFetch('/epics/api/user', { method: 'GET' }); 
            if (response.ok) {
                const epics = await response.json();
                epicSelect.innerHTML = '<option value="">Selecione um √©pico</option>'; // Reset ap√≥s carregar

                epics.forEach(epic => {
                    const option = document.createElement('option');
                    option.value = epic.id;
                    option.textContent = epic.title; // Exibe o t√≠tulo do √©pico
                    epicSelect.appendChild(option);
                });
            } else {
                const errorData = await response.json();
                console.error('Erro ao carregar √©picos para o select:', errorData);
                epicSelect.innerHTML = '<option value="">Erro ao carregar √©picos</option>';
            }
        } catch (error) {
            console.error('Erro de rede ao carregar √©picos para o select:', error);
            epicSelect.innerHTML = '<option value="">Erro de conex√£o</option>';
        }
    }


    // Fun√ß√£o para disparar a gera√ß√£o de √©picos via IA
    async function generateEpics(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const productId = formData.get('product_id');
        const customPrompt = formData.get('custom_prompt');
        const modalMessageDiv = document.getElementById('modal-message');
        const generateButton = form.querySelector('button[type="submit"]');

        modalMessageDiv.style.display = 'none'; // Esconde mensagens anteriores
        generateButton.disabled = true; // Desabilita o bot√£o para evitar cliques m√∫ltiplos
        generateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Gerando...'; // Feedback visual

        if (!productId) {
            modalMessageDiv.style.display = 'block';
            modalMessageDiv.style.backgroundColor = '#f8d7da';
            modalMessageDiv.style.color = '#721c24';
            modalMessageDiv.textContent = 'Por favor, selecione um produto.';
            generateButton.disabled = false;
            generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i> Gerar √âpicos';
            return;
        }

        try {
            // A rota √© /epics/generate/<product_id> (POST)
            const response = await authenticatedFetch(`/epics/generate/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ custom_prompt: customPrompt }) // Envia custom_prompt se houver
            });

            const data = await response.json();

            if (response.ok) {
                modalMessageDiv.style.display = 'block';
                modalMessageDiv.style.backgroundColor = '#d4edda';
                modalMessageDiv.style.color = '#155724';
                modalMessageDiv.textContent = data.message || '√âpicos gerados com sucesso!';
                
                setTimeout(() => {
                    closeModal('generateEpicsModal');
                    location.reload(); // Recarrega a p√°gina para ver os novos √©picos
                }, 2000);

            } else {
                modalMessageDiv.style.display = 'block';
                modalMessageDiv.style.backgroundColor = '#f8d7da';
                modalMessageDiv.style.color = '#721c24';
                modalMessageDiv.textContent = data.message || 'Erro ao gerar √©picos.';
                console.error('Erro na resposta da API ao gerar √©picos:', data); // Use 'data' para ver a resposta do servidor
            }
        } catch (error) {
            modalMessageDiv.style.display = 'block';
            modalMessageDiv.style.backgroundColor = '#f8d7da';
            modalMessageDiv.style.color = '#721c24';
            modalMessageDiv.textContent = 'Ocorreu um erro de rede ou servidor ao gerar √©picos.';
            console.error('Erro de rede ao gerar √©picos:', error);
        } finally {
            generateButton.disabled = false;
            generateButton.innerHTML = '<i class="fas fa-magic mr-2"></i> Gerar √âpicos';
        }
    }

    // Fun√ß√£o para Criar √âpico Manualmente
    async function createEpic(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const productId = formData.get('product_id');
        const title = formData.get('title');
        const description = formData.get('description');
        const modalMessageDiv = document.getElementById('modal-message'); // Reutilizando para este modal
        const createButton = form.querySelector('button[type="submit"]');

        modalMessageDiv.style.display = 'none';
        createButton.disabled = true;
        createButton.textContent = 'Criando...';

        try {
            const response = await authenticatedFetch('/epics', { // Rota POST /epics
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ product_id: productId, title, description })
            });

            const data = await response.json();

            if (response.ok) {
                modalMessageDiv.style.display = 'block';
                modalMessageDiv.style.backgroundColor = '#d4edda';
                modalMessageDiv.style.color = '#155724';
                modalMessageDiv.textContent = data.message || '√âpico criado manualmente com sucesso!';
                
                setTimeout(() => {
                    closeModal('createEpicModal');
                    location.reload();
                }, 2000);

            } else {
                modalMessageDiv.style.display = 'block';
                modalMessageDiv.style.backgroundColor = '#f8d7da';
                modalMessageDiv.style.color = '#721c24';
                modalMessageDiv.textContent = data.message || 'Erro ao criar √©pico.';
                console.error('Erro na resposta da API ao criar √©pico:', data);
            }
        } catch (error) {
            modalMessageDiv.style.display = 'block';
            modalMessageDiv.style.backgroundColor = '#f8d7da';
            modalMessageDiv.style.color = '#721c24';
            modalMessageDiv.textContent = 'Ocorreu um erro de rede ou servidor ao criar √©pico.';
            console.error('Erro de rede ao criar √©pico:', error);
        } finally {
            createButton.disabled = false;
            createButton.textContent = 'Criar √âpico';
        }
    }

    // Fun√ß√µes de A√ß√£o para cada √©pico
    function navigateToEpicDetail(epicId) {
        window.location.href = `/epics/${epicId}`;
    }

    // Nova fun√ß√£o para navegar para hist√≥rias filtradas por √©pico
    function navigateToStoriesWithEpic(epicId, epicTitle) {
        // Debug logs
        console.log('Navegando para hist√≥rias do √©pico:', { epicId, epicTitle });
        
        // Usar a URL do Flask url_for para garantir a rota correta
        const baseUrl = "{{ url_for('user_story_bp.stories_page') }}";
        const url = `${baseUrl}?epic_id=${epicId}&epic_title=${encodeURIComponent(epicTitle)}`;
        
        console.log('URL constru√≠da:', url);
        
        // Usar a fun√ß√£o de navega√ß√£o autenticada do main.js
        navigateWithToken(url);
    }

    function editEpic(epicId) {
        // Abrir modal de edi√ß√£o
        openEditEpicModal(epicId);
    }

    // Fun√ß√£o para abrir modal de edi√ß√£o
    async function openEditEpicModal(epicId) {
        const modal = document.getElementById('editEpicModal');
        const epicIdInput = document.getElementById('editEpicId');
        const titleInput = document.getElementById('editEpicTitle');
        const descriptionInput = document.getElementById('editEpicDescription');
        const statusSelect = document.getElementById('editEpicStatus');
        const warningMessage = document.getElementById('editWarningMessage');
        const modalMessage = document.getElementById('modal-message-edit');
        
        // Limpar mensagens anteriores
        modalMessage.style.display = 'none';
        warningMessage.style.display = 'none';
        
        try {
            // Buscar dados do √©pico e estat√≠sticas em paralelo
            const [epicResponse, statsResponse] = await Promise.all([
                authenticatedFetch(`/epics/${epicId}`, { method: 'GET' }),
                authenticatedFetch(`/epics/${epicId}/stats`, { method: 'GET' })
            ]);
            
            if (epicResponse.ok && statsResponse.ok) {
                const epicData = await epicResponse.json();
                const statsData = await statsResponse.json();
                
                // Preencher formul√°rio
                epicIdInput.value = epicData.id;
                titleInput.value = epicData.title;
                descriptionInput.value = epicData.description;
                statusSelect.value = epicData.status;
                
                // Verificar se h√° hist√≥rias associadas
                const hasStories = statsData.totalStories && statsData.totalStories > 0;
                
                if (hasStories) {
                    // Mostrar aviso e desabilitar campos
                    warningMessage.style.display = 'block';
                    titleInput.disabled = true;
                    descriptionInput.disabled = true;
                    titleInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                    descriptionInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                } else {
                    // Habilitar campos
                    titleInput.disabled = false;
                    descriptionInput.disabled = false;
                    titleInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    descriptionInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
                
                // Mostrar modal
                modal.style.display = 'flex';
                
            } else {
                let errorMessage = 'Erro ao carregar dados do √©pico';
                if (!epicResponse.ok) {
                    const errorData = await epicResponse.json();
                    errorMessage = errorData.message || errorMessage;
                }
                showToast(errorMessage, 'error');
            }
        } catch (error) {
            console.error('Erro ao carregar dados do √©pico:', error);
            showToast('Erro de conex√£o ao carregar dados do √©pico', 'error');
        }
    }

    // Fun√ß√£o para atualizar √©pico
    async function updateEpic(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const epicId = formData.get('epic_id');
        const title = formData.get('title');
        const description = formData.get('description');
        const status = formData.get('status');
        const modalMessage = document.getElementById('modal-message-edit');
        const updateButton = form.querySelector('button[type="submit"]');
        
        modalMessage.style.display = 'none';
        updateButton.disabled = true;
        updateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';
        
        try {
            const response = await authenticatedFetch(`/epics/${epicId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, description, status })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                modalMessage.style.display = 'block';
                modalMessage.style.backgroundColor = '#d4edda';
                modalMessage.style.color = '#155724';
                modalMessage.textContent = data.message || '√âpico atualizado com sucesso!';
                
                setTimeout(() => {
                    closeModal('editEpicModal');
                    location.reload(); // Recarregar para mostrar altera√ß√µes
                }, 2000);
                
            } else {
                modalMessage.style.display = 'block';
                modalMessage.style.backgroundColor = '#f8d7da';
                modalMessage.style.color = '#721c24';
                modalMessage.textContent = data.message || 'Erro ao atualizar √©pico.';
            }
        } catch (error) {
            console.error('Erro ao atualizar √©pico:', error);
            modalMessage.style.display = 'block';
            modalMessage.style.backgroundColor = '#f8d7da';
            modalMessage.style.color = '#721c24';
            modalMessage.textContent = 'Erro de conex√£o ao atualizar √©pico.';
        } finally {
            updateButton.disabled = false;
            updateButton.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Altera√ß√µes';
        }
    }

    function generateStories(epicId) {
        // Gerar hist√≥rias diretamente sem confirma√ß√£o
        generateStoriesForEpic(epicId);
    }

    // Sistema de notifica√ß√µes toast
    function showToast(message, type = 'info') {
        // Remover toasts existentes
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());

        // Criar novo toast
        const toast = document.createElement('div');
        toast.className = `toast-notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium max-w-sm transition-all duration-300 transform translate-x-full`;
        
        // Definir cor baseada no tipo
        switch (type) {
            case 'success':
                toast.classList.add('bg-green-500');
                break;
            case 'error':
                toast.classList.add('bg-red-500');
                break;
            case 'info':
            default:
                toast.classList.add('bg-blue-500');
                break;
        }

        // Adicionar √≠cone baseado no tipo
        let icon = '';
        switch (type) {
            case 'success':
                icon = '<i class="fas fa-check-circle mr-2"></i>';
                break;
            case 'error':
                icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
                break;
            case 'info':
            default:
                icon = '<i class="fas fa-info-circle mr-2"></i>';
                break;
        }

        toast.innerHTML = `
            <div class="flex items-center">
                ${icon}
                <span>${message}</span>
            </div>
        `;

        // Adicionar ao DOM
        document.body.appendChild(toast);

        // Animar entrada
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        // Remover automaticamente ap√≥s 4 segundos
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 4000);
    }

    // Fun√ß√£o auxiliar para buscar contagem de hist√≥rias com retry
    async function getStoriesCountWithRetry(epicId, maxRetries = 3, delay = 800) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`Tentativa ${attempt} de buscar contagem de hist√≥rias para √©pico ${epicId}`);
                
                const response = await authenticatedFetch(`/epics/${epicId}/stats`);
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.totalStories || 0;
                    console.log(`Contagem obtida na tentativa ${attempt}: ${count}`);
                    return count;
                } else {
                    console.warn(`Tentativa ${attempt} falhou com status:`, response.status);
                }
            } catch (error) {
                console.warn(`Tentativa ${attempt} falhou com erro:`, error);
            }
            
            // Aguardar antes da pr√≥xima tentativa (exceto na √∫ltima)
            if (attempt < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, delay));
                delay = delay * 1.5; // Aumentar delay progressivamente
            }
        }
        
        console.error(`Falha ao obter contagem ap√≥s ${maxRetries} tentativas`);
        return null;
    }

    // Anima√ß√£o para contador crescente
    function animateCounter(element, fromValue, toValue) {
        const duration = 800; // ms
        const steps = 20;
        const stepTime = duration / steps;
        const stepValue = (toValue - fromValue) / steps;
        let currentValue = fromValue;
        let currentStep = 0;

        const interval = setInterval(() => {
            currentStep++;
            currentValue += stepValue;
            
            if (currentStep >= steps) {
                element.textContent = toValue;
                clearInterval(interval);
            } else {
                element.textContent = Math.round(currentValue);
            }
        }, stepTime);
    }

    async function generateStoriesForEpic(epicId) {
        const epicCard = document.querySelector(`[data-id="${epicId}"]`);
        const storiesCountElement = epicCard ? epicCard.querySelector('.stat-card-stories .text-sm.font-semibold') : null;
        const originalText = storiesCountElement ? storiesCountElement.textContent : '0';
        const previousCount = parseInt(originalText) || 0;
        
        if (!epicCard || !storiesCountElement) {
            console.error('Elementos n√£o encontrados para √©pico:', epicId);
            showToast('Erro: Elementos do card n√£o encontrados', 'error');
            return;
        }

        try {
            // Feedback visual imediato - estado de loading
            storiesCountElement.textContent = '...';
            storiesCountElement.classList.add('stat-loading');
            
            // Adicionar classe de highlight no card de hist√≥rias
            const storiesCard = epicCard.querySelector('.stat-card-stories');
            if (storiesCard) {
                storiesCard.classList.add('generating-stories');
            }

            // Adicionar efeito shimmer ao card inteiro
            epicCard.classList.add('generating-stories');

            // Desabilitar bot√£o para evitar m√∫ltiplos cliques
            const generateButton = document.querySelector(`[onclick*="generateStories(${epicId})"]`);
            if (generateButton) {
                generateButton.disabled = true;
                generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // Feedback visual com toast notification
            showToast('Gerando hist√≥rias com IA...', 'info');

            // Fazer a chamada para gerar hist√≥rias
            console.log(`Iniciando gera√ß√£o de hist√≥rias para √©pico ${epicId}...`);
            
            const response = await authenticatedFetch(`/user-stories/generate/${epicId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ custom_prompt: '' })
            });

            console.log('Resposta da API:', {
                status: response.status,
                statusText: response.statusText,
                url: response.url
            });

            const data = await response.json();
            console.log('Dados retornados pela API:', data);

            if (response.ok) {
                // Atualizar toast para mostrar que est√° verificando
                showToast('Hist√≥rias geradas! Atualizando contagem...', 'info');
                
                // Aguardar um pouco e buscar a contagem real atual
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Tentar buscar contagem atual com retry para garantir que BD foi atualizado
                const actualNewCount = await getStoriesCountWithRetry(epicId, 3);
                
                if (actualNewCount !== null) {
                    // Anima√ß√£o de contagem crescente com contagem real
                    animateCounter(storiesCountElement, previousCount, actualNewCount);
                    
                    // Feedback de sucesso baseado na contagem real
                    const generatedCount = actualNewCount - previousCount;
                    let message;
                    
                    if (generatedCount > 0) {
                        message = `${generatedCount} nova(s) hist√≥ria(s) gerada(s)! Total: ${actualNewCount}`;
                    } else if (actualNewCount > 0) {
                        message = `${actualNewCount} hist√≥ria(s) j√° existem para este √©pico`;
                    } else {
                        message = 'Gera√ß√£o conclu√≠da - verificar se foram criadas hist√≥rias';
                    }
                    
                    showToast(message, 'success');
                    
                } else {
                    // Fallback para resposta da API de gera√ß√£o
                    const storiesGenerated = data.user_stories?.length || 0;
                    const newTotal = Math.max(previousCount, previousCount + storiesGenerated);
                    
                    animateCounter(storiesCountElement, previousCount, newTotal);
                    showToast(`Hist√≥rias processadas! Recarregando contagem...`, 'success');
                    
                    // Tentar atualizar a contagem ap√≥s mais um tempo
                    setTimeout(() => {
                        refreshEpicStats(epicId);
                    }, 2000);
                }
                
                // Highlight no card de hist√≥rias por alguns segundos
                setTimeout(() => {
                    if (storiesCard) {
                        storiesCard.classList.remove('generating-stories');
                        storiesCard.classList.add('stats-updated');
                        
                        // Remover highlight ap√≥s anima√ß√£o
                        setTimeout(() => {
                            storiesCard.classList.remove('stats-updated');
                        }, 2000);
                    }
                }, 500);

                // Atualizar outras estat√≠sticas do √©pico
                setTimeout(() => {
                    refreshEpicStats(epicId);
                }, 1000);

            } else {
                // Erro - restaurar contador e mostrar erro
                storiesCountElement.textContent = originalText;
                showToast(data.message || 'Erro ao gerar hist√≥rias', 'error');
                console.error('Erro na resposta da API ao gerar hist√≥rias:', data);
            }
        } catch (error) {
            // Erro de rede - restaurar contador
            console.error('Erro capturado ao gerar hist√≥rias:', error);
            storiesCountElement.textContent = originalText;
            showToast('Erro de conex√£o ao gerar hist√≥rias: ' + error.message, 'error');
        } finally {
            // Remover estado de loading e efeitos
            storiesCountElement.classList.remove('stat-loading');
            epicCard.classList.remove('generating-stories');
            
            // Garantir limpeza de classes
            const storiesCard = epicCard.querySelector('.stat-card-stories');
            if (storiesCard) {
                storiesCard.classList.remove('generating-stories');
            }

            // Reabilitar bot√£o
            const generateButton = document.querySelector(`[onclick*="generateStories(${epicId})"]`);
            if (generateButton) {
                generateButton.disabled = false;
                generateButton.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }
    }

    // Fun√ß√£o para atualizar o contador de hist√≥rias no card do √©pico (OBSOLETA - mantida para compatibilidade)
    function updateEpicStoriesCount(epicId, newCount) {
        console.log('updateEpicStoriesCount chamada (obsoleta), usando refreshEpicStats ao inv√©s');
        // Chama a nova fun√ß√£o de atualiza√ß√£o
        refreshEpicStats(epicId);
    }

    // Fun√ß√£o para atualizar o progresso do √©pico (OBSOLETA - mantida para compatibilidade)
    function updateEpicProgress(epicId) {
        console.log('updateEpicProgress chamada (obsoleta), usando refreshEpicStats ao inv√©s');
        // Chama a nova fun√ß√£o de atualiza√ß√£o
        refreshEpicStats(epicId);
    }

    // Fun√ß√£o para recalcular estat√≠sticas do √©pico
    async function refreshEpicStats(epicId) {
        try {
            const response = await authenticatedFetch(`/epics/${epicId}/stats`, {
                method: 'GET'
            });

            if (response.ok) {
                const stats = await response.json();
                updateEpicStatsInCard(epicId, stats);
                return stats;
            } else {
                console.warn('Erro ao buscar estat√≠sticas do √©pico:', response.status);
                return null;
            }
        } catch (error) {
            console.log('Erro ao atualizar estat√≠sticas do √©pico:', error);
            return null;
        }
    }

    // Fun√ß√£o para atualizar todas as estat√≠sticas no card
    function updateEpicStatsInCard(epicId, stats) {
        const epicCard = document.querySelector(`[data-id="${epicId}"]`);
        if (epicCard && stats) {
            // Adicionar classe de highlight temporariamente
            epicCard.classList.add('stats-updated');
            
            // Atualizar contador de hist√≥rias
            const storiesElement = epicCard.querySelector('.stat-card-stories .text-sm.font-semibold');
            if (storiesElement && stats.totalStories !== undefined) {
                animateCounterUpdate(storiesElement, stats.totalStories);
            }
            
            // Atualizar total de requisitos
            const requirementsElement = epicCard.querySelectorAll('.text-sm.font-semibold')[1];
            if (requirementsElement && stats.totalRequirements !== undefined) {
                animateCounterUpdate(requirementsElement, stats.totalRequirements);
            }
            
            // Atualizar progresso
            if (stats.progress !== undefined) {
                const progressBar = epicCard.querySelector('.bg-gradient-to-r');
                const progressText = epicCard.querySelector('.font-medium');
                
                if (progressBar && progressText) {
                    progressBar.classList.add('progress-bar-animated');
                    progressBar.style.width = stats.progress + '%';
                    progressText.textContent = stats.progress + '%';
                }
            }
            
            // Remover highlight ap√≥s anima√ß√£o
            setTimeout(() => {
                epicCard.classList.remove('stats-updated');
            }, 1000);
        }
    }

    // Fun√ß√£o auxiliar para animar atualiza√ß√£o de contadores
    function animateCounterUpdate(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        
        if (currentValue !== newValue) {
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.2)';
            element.style.color = '#16a34a';
            
            // Animar contagem
            let start = currentValue;
            const increment = newValue > start ? 1 : -1;
            const duration = Math.abs(newValue - start) * 50; // 50ms por n√∫mero
            
            const counter = setInterval(() => {
                start += increment;
                element.textContent = start;
                
                if (start === newValue) {
                    clearInterval(counter);
                    
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                        element.style.color = '';
                    }, 150);
                }
            }, duration / Math.abs(newValue - currentValue));
        }
    }

    // Fun√ß√£o para atualizar a barra de progresso
    function updateProgress(percentage, message) {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressContainer = document.getElementById('progress-container');
        
        if (progressBar && progressText && progressContainer) {
            progressContainer.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressText.textContent = message;
        }
    }

    // Fun√ß√£o para mostrar mensagens de feedback melhorada
    function showFeedbackMessage(message, type = 'info', showProgress = false) {
        const feedbackDiv = document.getElementById('feedback-message');
        const feedbackContent = document.getElementById('feedback-content');
        const progressContainer = document.getElementById('progress-container');
        
        if (feedbackDiv && feedbackContent) {
            feedbackDiv.style.display = 'block';
            feedbackContent.innerHTML = message; // Usar innerHTML para suportar HTML
            
            // Mostrar/ocultar barra de progresso
            if (progressContainer) {
                progressContainer.style.display = showProgress ? 'block' : 'none';
            }
            
            // Remover classes anteriores
            feedbackDiv.className = 'mt-4 p-4 rounded-lg text-center font-medium';
            
            // Adicionar classe baseada no tipo
            switch(type) {
                case 'success':
                    feedbackDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                    break;
                case 'error':
                    feedbackDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                    break;
                case 'warning':
                    feedbackDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                    break;
                case 'info':
                default:
                    feedbackDiv.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
                    break;
            }
            
            // Auto-ocultar ap√≥s determinado tempo
            const hideTimeout = type === 'success' ? 6000 : (type === 'error' ? 0 : 5000);
            if (hideTimeout > 0) {
                setTimeout(() => {
                    feedbackDiv.style.display = 'none';
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                }, hideTimeout);
            }
        }
    }

    async function deleteEpic(epicId) {
        const confirmMessage = 'Tem certeza que deseja excluir este √©pico?\n\nATEN√á√ÉO: Todas as hist√≥rias de usu√°rio e requisitos vinculados a este √©pico tamb√©m ser√£o exclu√≠dos permanentemente.\n\nEsta a√ß√£o n√£o pode ser desfeita.';
        
        if (confirm(confirmMessage)) {
            try {
                showToast('Excluindo √©pico, hist√≥rias e requisitos...', 'info');
                
                const response = await authenticatedFetch(`/epics/${epicId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    showToast('√âpico, hist√≥rias e requisitos exclu√≠dos com sucesso!', 'success');
                    
                    // Remover o card do √©pico da interface
                    const epicCard = document.querySelector(`[data-id="${epicId}"]`);
                    if (epicCard) {
                        epicCard.style.transition = 'all 0.3s ease';
                        epicCard.style.opacity = '0';
                        epicCard.style.transform = 'scale(0.95)';
                        
                        setTimeout(() => {
                            epicCard.remove();
                            // Atualizar contador
                            allEpics = Array.from(document.querySelectorAll('.epic-item'));
                            updateResultsCount();
                            
                            // Verificar se n√£o h√° mais √©picos
                            if (allEpics.length === 0) {
                                const noEpicsMessage = document.getElementById('noEpicsMessage');
                                if (noEpicsMessage) {
                                    noEpicsMessage.classList.remove('hidden');
                                }
                            }
                        }, 300);
                    }
                } else {
                    const errorData = await response.json();
                    showToast(errorData.message || 'Erro ao excluir √©pico', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir √©pico:', error);
                showToast('Erro de conex√£o ao excluir √©pico', 'error');
            }
        }
    }

    // Fun√ß√£o para navega√ß√£o geral aos √©picos
    function navigateToEpics() {
        window.location.href = '/epics';
    }

</script>
{% endblock %}
